<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Resolution Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .file-name {
            margin-top: 15px;
            color: #666;
            font-style: italic;
        }

        .results-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .month-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .month-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .month-title {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .metric {
            margin-bottom: 15px;
        }

        .metric-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
        }

        .percentage {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .error.active {
            display: block;
        }

        .summary {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .summary h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .summary-item {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .summary-item .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .summary-item .label {
            color: #666;
            font-size: 0.9em;
        }

        .quarter-section {
            margin-bottom: 30px;
        }

        .quarter-section h2 {
            color: white;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .quarter-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
            color: white;
        }

        .quarter-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .quarter-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }

        .quarter-card .metric {
            margin-bottom: 15px;
        }

        .quarter-card .metric-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .quarter-card .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: white;
        }

        .quarter-card .percentage {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 1em;
            margin-top: 5px;
            font-weight: bold;
        }

        .quarter-card .progress-bar {
            background: rgba(255, 255, 255, 0.3);
        }

        .quarter-card .progress-fill {
            background: white;
        }

        .month-section h2 {
            color: white;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Ticket Resolution Analyzer</h1>
            <p>Upload your Excel file to analyze ticket resolution times</p>
        </div>

        <div class="upload-section">
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept=".xlsx, .xls">
                <label for="fileInput" class="file-input-label">
                    üìÅ Choose Excel File
                </label>
            </div>
            <div class="file-name" id="fileName">No file selected</div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Processing your file...</div>
        </div>

        <div class="error" id="error"></div>

        <div id="summaryContainer"></div>

        <div id="quarterSection" class="quarter-section">
            <div class="results-container" id="quarterResults"></div>
        </div>

        <div class="month-section">
            <h2 id="monthSectionTitle" style="display: none;">üìÖ Monthly Breakdown</h2>
            <div class="results-container" id="results"></div>
        </div>
    </div>

    <script>
        let currentFileName = '';

        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            currentFileName = file.name;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('loading').classList.add('active');
            document.getElementById('error').classList.remove('active');
            document.getElementById('results').innerHTML = '';
            document.getElementById('quarterResults').innerHTML = '';
            document.getElementById('summaryContainer').innerHTML = '';
            document.getElementById('monthSectionTitle').style.display = 'none';

            // Clear quarter section title if it exists
            const quarterSection = document.getElementById('quarterSection');
            const existingTitle = quarterSection.querySelector('h2');
            if (existingTitle) {
                existingTitle.remove();
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });

                    processWorkbook(workbook);
                    document.getElementById('loading').classList.remove('active');
                } catch (error) {
                    showError('Error processing file: ' + error.message);
                    document.getElementById('loading').classList.remove('active');
                }
            };

            reader.onerror = function() {
                showError('Error reading file');
                document.getElementById('loading').classList.remove('active');
            };

            reader.readAsArrayBuffer(file);
        }

        function processWorkbook(workbook) {
            const results = [];
            let totalTickets = 0;
            let totalResolvedIn2Days = 0;

            workbook.SheetNames.forEach(sheetName => {
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false, dateNF: 'yyyy-mm-dd' });

                if (jsonData.length === 0) return;

                const result = analyzeSheet(sheetName, jsonData);
                if (result) {
                    results.push(result);
                    totalTickets += result.totalTickets;
                    totalResolvedIn2Days += result.resolvedIn2Days;
                }
            });

            if (results.length === 0) {
                showError('No valid data found in the Excel file. Please ensure the file contains one of these header formats:\n- "Ticket created - Date" and "Ticket solved - Date"\n- "Issue created date" and "Issue resolution date"');
                return;
            }

            displaySummary(totalTickets, totalResolvedIn2Days);
            displayQuarterResults(results);
            displayResults(results);
        }

        function getQuarterFromSheetName(sheetName) {
            // Try sheet name first, then filename
            const searchStrings = [sheetName.toLowerCase()];
            if (currentFileName) {
                searchStrings.push(currentFileName.toLowerCase());
            }

            // Month mapping to quarters
            const monthToQuarter = {
                'january': 'Q1', 'jan': 'Q1',
                'february': 'Q1', 'feb': 'Q1',
                'march': 'Q1', 'mar': 'Q1',
                'april': 'Q2', 'apr': 'Q2',
                'may': 'Q2',
                'june': 'Q2', 'jun': 'Q2',
                'july': 'Q3', 'jul': 'Q3',
                'august': 'Q3', 'aug': 'Q3',
                'september': 'Q3', 'sep': 'Q3', 'sept': 'Q3',
                'october': 'Q4', 'oct': 'Q4',
                'november': 'Q4', 'nov': 'Q4',
                'december': 'Q4', 'dec': 'Q4'
            };

            for (const searchStr of searchStrings) {
                // Check if contains month name
                for (const [month, quarter] of Object.entries(monthToQuarter)) {
                    if (searchStr.includes(month)) {
                        return quarter;
                    }
                }

                // Check if contains Q1, Q2, Q3, Q4
                if (searchStr.includes('q1') || searchStr.includes('quarter 1')) return 'Q1';
                if (searchStr.includes('q2') || searchStr.includes('quarter 2')) return 'Q2';
                if (searchStr.includes('q3') || searchStr.includes('quarter 3')) return 'Q3';
                if (searchStr.includes('q4') || searchStr.includes('quarter 4')) return 'Q4';
            }

            return null;
        }

        function calculateQuarterStats(results) {
            const quarters = {
                'Q1': { totalTickets: 0, resolvedIn2Days: 0, months: [] },
                'Q2': { totalTickets: 0, resolvedIn2Days: 0, months: [] },
                'Q3': { totalTickets: 0, resolvedIn2Days: 0, months: [] },
                'Q4': { totalTickets: 0, resolvedIn2Days: 0, months: [] }
            };

            results.forEach(result => {
                const quarter = getQuarterFromSheetName(result.sheetName);
                if (quarter && quarters[quarter]) {
                    quarters[quarter].totalTickets += result.totalTickets;
                    quarters[quarter].resolvedIn2Days += result.resolvedIn2Days;
                    quarters[quarter].months.push(result.sheetName);
                }
            });

            // Calculate percentages and filter out empty quarters
            const quarterResults = [];
            for (const [quarterName, data] of Object.entries(quarters)) {
                if (data.totalTickets > 0) {
                    const percentage = ((data.resolvedIn2Days / data.totalTickets) * 100).toFixed(2);
                    quarterResults.push({
                        quarterName,
                        totalTickets: data.totalTickets,
                        resolvedIn2Days: data.resolvedIn2Days,
                        percentage,
                        months: data.months
                    });
                }
            }

            return quarterResults;
        }

        function displayQuarterResults(results) {
            const quarterResults = calculateQuarterStats(results);

            if (quarterResults.length === 0) return;

            const quarterContainer = document.getElementById('quarterResults');
            const quarterSection = document.getElementById('quarterSection');

            // Add title
            const title = document.createElement('h2');
            title.textContent = 'üìä Quarterly Summary';
            title.style.color = 'white';
            title.style.marginBottom = '20px';
            title.style.fontSize = '1.8em';
            quarterSection.insertBefore(title, quarterContainer);

            quarterResults.forEach(quarter => {
                const card = document.createElement('div');
                card.className = 'quarter-card';

                const monthsList = quarter.months.join(', ');

                card.innerHTML = `
                    <div class="quarter-title">üìà ${quarter.quarterName}</div>
                    <div class="metric">
                        <div class="metric-label">Months: ${monthsList}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Total Tickets</div>
                        <div class="metric-value">${quarter.totalTickets}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Resolved in ‚â§2 Days</div>
                        <div class="metric-value">${quarter.resolvedIn2Days}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Success Rate</div>
                        <div class="percentage">${quarter.percentage}%</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${quarter.percentage}%"></div>
                    </div>
                `;

                quarterContainer.appendChild(card);
            });

            // Show monthly section title
            document.getElementById('monthSectionTitle').style.display = 'block';
        }

        function analyzeSheet(sheetName, data) {
            let resolvedIn2Days = 0;
            let totalTickets = 0;

            // Find the correct column headers (case-insensitive)
            const headers = Object.keys(data[0] || {});

            // Support multiple header formats
            // Format 1: "Ticket created - Date", "Ticket solved - Date"
            // Format 2: "Issue created date", "Issue resolution date"
            let createdDateCol = headers.find(h =>
                h.toLowerCase().includes('ticket created') ||
                h.toLowerCase().includes('issue created')
            );
            let solvedDateCol = headers.find(h =>
                h.toLowerCase().includes('ticket solved') ||
                h.toLowerCase().includes('issue resolution') ||
                h.toLowerCase().includes('issue resolved')
            );

            if (!createdDateCol || !solvedDateCol) {
                console.warn(`Sheet "${sheetName}" doesn't have the expected columns. Looking for created/solved date columns.`);
                return null;
            }

            data.forEach(row => {
                // Skip empty rows
                if (!row[createdDateCol] || !row[solvedDateCol]) {
                    return;
                }

                totalTickets++;

                // Calculate from created and solved dates
                const createdDate = parseDate(row[createdDateCol]);
                const solvedDate = parseDate(row[solvedDateCol]);

                if (createdDate && solvedDate) {
                    const diffTime = Math.abs(solvedDate - createdDate);
                    const diffDays = diffTime / (1000 * 60 * 60 * 24);

                    if (diffDays <= 2) {
                        resolvedIn2Days++;
                    }
                }
            });

            const percentage = totalTickets > 0 ? ((resolvedIn2Days / totalTickets) * 100).toFixed(2) : 0;

            return {
                sheetName,
                totalTickets,
                resolvedIn2Days,
                percentage
            };
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;

            // If it's already a Date object
            if (dateStr instanceof Date) {
                return dateStr;
            }

            // Convert to string if it's not
            const str = String(dateStr).trim();
            if (!str) return null;

            // Try parsing as is (handles ISO dates and datetime)
            // Examples: "2025-08-12 13:46:04", "2025-09-26", "Aug 03 2025"
            let date = new Date(str);
            if (!isNaN(date.getTime())) {
                return date;
            }

            // Try parsing common date formats with regex
            const formats = [
                // YYYY-MM-DD HH:MM:SS
                /(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2}):(\d{2})/,
                // YYYY-MM-DD
                /(\d{4})-(\d{2})-(\d{2})/,
                // DD/MM/YYYY
                /(\d{2})\/(\d{2})\/(\d{4})/,
                // MM/DD/YYYY
                /(\d{1,2})\/(\d{1,2})\/(\d{4})/,
                // DD-MM-YYYY
                /(\d{2})-(\d{2})-(\d{4})/,
            ];

            for (const format of formats) {
                const match = str.match(format);
                if (match) {
                    date = new Date(str);
                    if (!isNaN(date.getTime())) {
                        return date;
                    }
                }
            }

            // Try parsing month name formats like "Aug 03 2025"
            // Month abbreviations
            const monthAbbr = {
                'jan': 0, 'feb': 1, 'mar': 2, 'apr': 3, 'may': 4, 'jun': 5,
                'jul': 6, 'aug': 7, 'sep': 8, 'oct': 9, 'nov': 10, 'dec': 11,
                'january': 0, 'february': 1, 'march': 2, 'april': 3, 'june': 6,
                'july': 6, 'august': 7, 'september': 8, 'october': 9, 'november': 10, 'december': 11
            };

            // Try: "Aug 03 2025" or "August 03 2025"
            const monthDayYear = str.match(/([a-z]+)\s+(\d{1,2})[,\s]+(\d{4})/i);
            if (monthDayYear) {
                const month = monthAbbr[monthDayYear[1].toLowerCase()];
                if (month !== undefined) {
                    const day = parseInt(monthDayYear[2]);
                    const year = parseInt(monthDayYear[3]);
                    return new Date(year, month, day);
                }
            }

            // Try: "03 Aug 2025"
            const dayMonthYear = str.match(/(\d{1,2})\s+([a-z]+)[,\s]+(\d{4})/i);
            if (dayMonthYear) {
                const month = monthAbbr[dayMonthYear[2].toLowerCase()];
                if (month !== undefined) {
                    const day = parseInt(dayMonthYear[1]);
                    const year = parseInt(dayMonthYear[3]);
                    return new Date(year, month, day);
                }
            }

            return null;
        }

        function displaySummary(totalTickets, totalResolvedIn2Days) {
            const percentage = totalTickets > 0 ? ((totalResolvedIn2Days / totalTickets) * 100).toFixed(2) : 0;

            const summaryHTML = `
                <div class="summary">
                    <h2>üìà Overall Summary</h2>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="value">${totalTickets}</div>
                            <div class="label">Total Tickets</div>
                        </div>
                        <div class="summary-item">
                            <div class="value">${totalResolvedIn2Days}</div>
                            <div class="label">Resolved in ‚â§2 Days</div>
                        </div>
                        <div class="summary-item">
                            <div class="value">${percentage}%</div>
                            <div class="label">Success Rate</div>
                        </div>
                        <div class="summary-item">
                            <div class="value">${totalTickets - totalResolvedIn2Days}</div>
                            <div class="label">Resolved in >2 Days</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('summaryContainer').innerHTML = summaryHTML;
        }

        function displayResults(results) {
            const resultsContainer = document.getElementById('results');

            results.forEach(result => {
                const card = document.createElement('div');
                card.className = 'month-card';

                card.innerHTML = `
                    <div class="month-title">üìÖ ${result.sheetName}</div>
                    <div class="metric">
                        <div class="metric-label">Total Tickets</div>
                        <div class="metric-value">${result.totalTickets}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Resolved in ‚â§2 Days</div>
                        <div class="metric-value">${result.resolvedIn2Days}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Success Rate</div>
                        <div class="percentage">${result.percentage}%</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${result.percentage}%"></div>
                    </div>
                `;

                resultsContainer.appendChild(card);
            });
        }

        function showError(message) {
            const errorElement = document.getElementById('error');
            errorElement.textContent = message;
            errorElement.classList.add('active');
        }
    </script>
</body>
</html>
