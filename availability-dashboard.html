<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Availability Dashboard - QA Analytics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="src/static/dashboard.css">
    <link rel="stylesheet" href="src/static/statistics.css">
    <link rel="stylesheet" href="/src/static/nav-dropdown.css">
    <link rel="stylesheet" href="src/static/footer.css">
    <link rel="stylesheet" href="/src/static/toast.css">
    <style>
        .availability-card {
            background: white;
            border-radius: var(--radius-2xl);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .availability-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-2xl);
        }

        .availability-percentage {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary);
            margin: var(--spacing-md) 0;
        }

        .availability-good {
            color: var(--success);
        }

        .availability-medium {
            color: var(--warning);
        }

        .availability-low {
            color: var(--danger);
        }

        .portfolio-section {
            margin-bottom: var(--spacing-3xl);
        }

        .portfolio-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: var(--spacing-xl);
            border-radius: var(--radius-2xl);
            margin-bottom: var(--spacing-xl);
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-xl);
        }

        .project-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary);
        }

        .quarter-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        .quarter-box {
            background: var(--gray-50);
            padding: var(--spacing-md);
            border-radius: var(--radius-lg);
            text-align: center;
        }

        .quarter-label {
            font-size: 0.75rem;
            color: var(--gray-600);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quarter-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: var(--spacing-xs);
        }

        .year-selector {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
        }

        .year-btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-lg);
            border: 2px solid var(--gray-300);
            background: white;
            color: var(--gray-700);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .year-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .year-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--gray-300);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
        }

        .summary-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
            text-align: center;
        }

        .summary-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin: var(--spacing-sm) 0;
        }

        .summary-label {
            color: var(--gray-600);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
        <nav class="navbar">
        <div class="navbar-container-new">
            <div class="navbar-links-left">
                <a href="/dashboard" class="nav-btn"><i class="fas fa-chart-bar"></i> Dashboard</a>
                <a href="/" class="nav-btn"><i class="fas fa-file-alt"></i> Ticket Analyzer</a>
            </div>

            <a href="/dashboard" class="navbar-brand-center">
                <div class="navbar-brand-icon"><i class="fas fa-line-chart"></i></div>
            </a>

            <div class="navbar-links-right">
                <div class="nav-dropdown">
                    <a href="#" class="nav-btn"><i class="fas fa-trophy"></i> Performance <i class="fas fa-chevron-down"></i></a>
                    <div class="nav-dropdown-content">
                        <a href="/performance-statistics"><i class="fas fa-upload"></i> Upload Stats</a>
                        <a href="/project-statistics"><i class="fas fa-project-diagram"></i> Project Stats</a>
                        <a href="/portfolio-statistics"><i class="fas fa-briefcase"></i> Portfolio Stats</a>
                    </div>
                </div>
                <div class="nav-dropdown">
                    <a href="#" class="nav-btn"><i class="fas fa-server"></i> Availability <i class="fas fa-chevron-down"></i></a>
                    <div class="nav-dropdown-content">
                        <a href="/project-availability"><i class="fas fa-upload"></i> Upload Stats</a>
                        <a href="/availability-dashboard"><i class="fas fa-chart-pie"></i> Dashboard</a>
                    </div>
                </div>
                <div class="nav-dropdown">
                    <a href="#" class="nav-btn"><i class="fas fa-cog"></i> Manage <i class="fas fa-chevron-down"></i></a>
                    <div class="nav-dropdown-content">
                        <a href="/projects"><i class="fas fa-folder"></i> Projects</a>
                        <a href="/portfolios"><i class="fas fa-briefcase"></i> Portfolios</a>
                        <a href="/settings"><i class="fas fa-cog"></i> Settings</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Hero -->
        <div class="hero">
            <h1><i class="fas fa-server"></i> Project Availability Dashboard</h1>
            <p>View availability analytics across portfolios and projects</p>
        </div>

        <!-- Year Selector -->
        <div class="year-selector" id="yearSelector"></div>

        <!-- Summary Statistics -->
        <div class="summary-stats" id="summaryStats"></div>

        <!-- Portfolios and Projects -->
        <div id="portfoliosContainer"></div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2024 QA Analytics Dashboard. All rights reserved.</p>
        </div>
    </footer>

    <script src="/src/static/toast.js"></script>
    <script>
        let selectedYear = new Date().getFullYear();
        let portfoliosData = [];
        let projectsData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
        });

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        async function loadData() {
            showLoading();
            try {
                // Fetch portfolios
                const portfoliosResponse = await fetch('/api/portfolios');
                const portfoliosResult = await portfoliosResponse.json();

                // Fetch projects
                const projectsResponse = await fetch('/api/projects');
                const projectsResult = await projectsResponse.json();

                // Fetch availability statistics
                const statsResponse = await fetch('/api/portfolio-availability-statistics');
                const statsResult = await statsResponse.json();

                portfoliosData = statsResult.portfolios || [];
                projectsData = projectsResult.projects || [];

                // Get all available years
                const years = new Set();
                portfoliosData.forEach(portfolio => {
                    Object.keys(portfolio.years || {}).forEach(year => years.add(parseInt(year)));
                });

                renderYearSelector(Array.from(years).sort((a, b) => b - a));
                renderSummary();
                renderPortfolios();
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error loading data: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function renderYearSelector(years) {
            const container = document.getElementById('yearSelector');
            if (years.length === 0) {
                container.innerHTML = '<p style="color: var(--gray-600);">No data available</p>';
                return;
            }

            container.innerHTML = years.map(year => `
                <button class="year-btn ${year === selectedYear ? 'active' : ''}"
                        onclick="selectYear(${year})">
                    ${year}
                </button>
            `).join('');
        }

        function selectYear(year) {
            selectedYear = year;
            renderYearSelector(Array.from(new Set(
                portfoliosData.flatMap(p => Object.keys(p.years || {}).map(y => parseInt(y)))
            )).sort((a, b) => b - a));
            renderSummary();
            renderPortfolios();
        }

        function renderSummary() {
            const container = document.getElementById('summaryStats');

            let totalProjects = 0;
            let totalDataPoints = 0;
            let totalAvailability = 0;
            let availabilityCount = 0;

            portfoliosData.forEach(portfolio => {
                const yearData = portfolio.years[selectedYear];
                if (yearData) {
                    totalDataPoints += portfolio.total_data_points;
                    Object.values(yearData.quarters).forEach(quarter => {
                        if (quarter.average > 0) {
                            totalAvailability += quarter.average;
                            availabilityCount++;
                        }
                    });
                }
            });

            const avgAvailability = availabilityCount > 0 ? (totalAvailability / availabilityCount).toFixed(2) : 0;
            const availabilityClass = getAvailabilityClass(avgAvailability);

            container.innerHTML = `
                <div class="summary-card">
                    <div class="summary-label">
                        <i class="fas fa-briefcase"></i> Total Portfolios
                    </div>
                    <div class="summary-value" style="color: var(--primary);">
                        ${portfoliosData.length}
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">
                        <i class="fas fa-database"></i> Data Points
                    </div>
                    <div class="summary-value" style="color: var(--secondary);">
                        ${totalDataPoints}
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">
                        <i class="fas fa-server"></i> Average Availability
                    </div>
                    <div class="summary-value ${availabilityClass}">
                        ${avgAvailability}%
                    </div>
                </div>
            `;
        }

        function renderPortfolios() {
            const container = document.getElementById('portfoliosContainer');

            if (portfoliosData.length === 0) {
                container.innerHTML = `
                    <div class="availability-card">
                        <p style="text-align: center; color: var(--gray-600);">
                            <i class="fas fa-info-circle"></i> No availability data available.
                            <a href="/project-availability" style="color: var(--primary);">Upload data</a> to get started.
                        </p>
                    </div>
                `;
                return;
            }

            container.innerHTML = portfoliosData.map(portfolio => {
                const yearData = portfolio.years[selectedYear];
                if (!yearData) return '';

                // Get projects for this portfolio
                const portfolioProjects = projectsData.filter(p => p.portfolio_id === portfolio.id);

                // Calculate portfolio average for the year
                const quarters = Object.values(yearData.quarters);
                const validQuarters = quarters.filter(q => q.average > 0);
                const portfolioAvg = validQuarters.length > 0
                    ? (validQuarters.reduce((sum, q) => sum + q.average, 0) / validQuarters.length).toFixed(2)
                    : 0;

                const availabilityClass = getAvailabilityClass(portfolioAvg);

                return `
                    <div class="portfolio-section">
                        <div class="portfolio-header">
                            <h2 style="margin: 0 0 var(--spacing-sm) 0;">
                                <i class="fas fa-briefcase"></i> ${portfolio.name}
                            </h2>
                            <p style="margin: 0; opacity: 0.9;">${portfolio.description || 'No description'}</p>
                            <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-xl); align-items: center;">
                                <div>
                                    <div style="font-size: 0.875rem; opacity: 0.8;">Projects</div>
                                    <div style="font-size: 1.5rem; font-weight: 700;">${portfolio.project_count}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; opacity: 0.8;">Data Points</div>
                                    <div style="font-size: 1.5rem; font-weight: 700;">${portfolio.total_data_points}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; opacity: 0.8;">Avg Availability (${selectedYear})</div>
                                    <div style="font-size: 2rem; font-weight: 800;">${portfolioAvg}%</div>
                                </div>
                            </div>
                        </div>

                        <div class="quarter-stats">
                            ${['Q1', 'Q2', 'Q3', 'Q4'].map(q => {
                                const qData = yearData.quarters[q];
                                const qAvg = qData.average || 0;
                                const qClass = getAvailabilityClass(qAvg);
                                return `
                                    <div class="quarter-box">
                                        <div class="quarter-label">${q}</div>
                                        <div class="quarter-value ${qClass}">${qAvg.toFixed(2)}%</div>
                                        <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: var(--spacing-xs);">
                                            ${qData.count || 0} data points
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getAvailabilityClass(value) {
            const val = parseFloat(value);
            if (val >= 95) return 'availability-good';
            if (val >= 80) return 'availability-medium';
            return 'availability-low';
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            document.getElementById('toastContainer').appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
