<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projects - QA Analytics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/src/static/projects.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/dashboard.html" class="navbar-brand">
                <div class="navbar-brand-icon"><i class="fas fa-line-chart"></i></div>
                <span>QA Analytics</span>
            </a>
            <div class="navbar-links">
                <a href="/dashboard.html" class="nav-btn"><i class="fas fa-chart-bar"></i> Dashboard</a>
                <a href="/" class="nav-btn"><i class="fas fa-file-alt"></i> Ticket Analyzer</a>
                <a href="/projects.html" class="nav-btn active"><i class="fas fa-sitemap"></i> Projects</a>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>Project Management</h1>
            <p>Create and organize your QA analysis projects</p>
        </div>

        <!-- Messages -->
        <div class="message message-success" id="successMessage">
            <i class="fas fa-check-circle"></i>
            <span id="successText"></span>
        </div>
        <div class="message message-error" id="errorMessage">
            <i class="fas fa-exclamation-circle"></i>
            <span id="errorText"></span>
        </div>

        <!-- Header Actions -->
        <div class="header-actions">
            <div class="section-header">
                <h2><i class="fas fa-layer-group"></i> Your Projects</h2>
                <p>Manage and organize all your QA analysis projects</p>
            </div>
            <button class="btn-create-project" onclick="openModal()">
                <i class="fas fa-plus"></i>
                New Project
            </button>
        </div>

        <!-- Projects List -->
        <div class="projects-section">
            <div class="projects-grid" id="projectsGrid">
                <!-- Projects will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay active" id="loadingOverlay">
        <div class="loading">
            <div class="spinner"></div>
            <h3>Loading projects...</h3>
            <p>Please wait</p>
        </div>
    </div>

    <!-- Create Project Modal -->
    <div class="modal" id="createModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> Create New Project</h2>
                <button class="close-btn" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="projectForm">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-tag"></i>
                        Project Name *
                    </label>
                    <input type="text" id="projectName" class="form-input" required placeholder="e.g., Customer Support Team">
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-align-left"></i>
                        Description
                    </label>
                    <textarea id="projectDescription" class="form-textarea" placeholder="Brief description of the project (optional)"></textarea>
                </div>

                <button type="submit" class="btn-primary" id="submitBtn">
                    <i class="fas fa-plus"></i>
                    Create Project
                </button>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <div class="confirm-header">
                <div class="confirm-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="confirm-header-text">
                    <h3>Delete Project</h3>
                    <p>This action cannot be undone</p>
                </div>
            </div>
            <div class="confirm-body">
                <p>Are you sure you want to delete <span class="confirm-project-name" id="confirmProjectName"></span>?</p>
                <p style="margin-top: 0.75rem; color: var(--gray-600); font-size: 0.875rem;">This will also delete all associated records.</p>
                <div class="form-group" style="margin-top: 1.25rem;">
                    <label class="form-label" style="color: var(--gray-900); font-size: 0.875rem;">
                        <i class="fas fa-keyboard"></i>
                        Type <strong id="confirmProjectNameInput"></strong> to confirm
                    </label>
                    <input type="text" id="deleteConfirmInput" class="form-input" placeholder="Enter project name" autocomplete="off">
                </div>
            </div>
            <div class="confirm-actions">
                <button class="btn-cancel" onclick="closeConfirmModal()">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button class="btn-confirm-delete" id="confirmDeleteBtn" onclick="confirmDelete()" disabled>
                    <i class="fas fa-trash-alt"></i>
                    Delete
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';

        // Form submission
        document.getElementById('projectForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('projectName').value.trim();
            const description = document.getElementById('projectDescription').value.trim();

            if (!name) {
                showError('Project name is required');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, description })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create project');
                }

                showSuccess('Project created successfully!');
                document.getElementById('projectForm').reset();
                closeModal();
                loadProjects();
            } catch (error) {
                showError(error.message);
            }
        });

        // Show/hide loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Load projects
        async function loadProjects() {
            showLoading();
            try {
                const response = await fetch(`${API_URL}/projects`);
                const data = await response.json();

                const container = document.getElementById('projectsGrid');

                if (!data.projects || data.projects.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-folder-plus empty-state-icon"></i>
                            <h3>No projects yet</h3>
                            <p>Click "New Project" to create your first project</p>
                        </div>
                    `;
                    hideLoading();
                    return;
                }

                let html = '';
                data.projects.forEach(project => {
                    html += `
                        <div class="project-card">
                            <div class="project-header">
                                <div class="project-title-section">
                                    <div class="project-name">
                                        <i class="fas fa-project-diagram"></i>
                                        ${project.name}
                                    </div>
                                </div>
                            </div>
                            ${project.description ? `<div class="project-description">${project.description}</div>` : '<div class="project-description" style="color: #9ca3af; font-style: italic;">No description provided</div>'}
                            <div class="project-meta">
                                <div class="meta-item">
                                    <i class="fas fa-calendar-plus"></i>
                                    Created: ${new Date(project.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                                </div>
                            </div>
                            <div class="project-actions">
                                <button class="btn-delete" onclick="deleteProject(${project.id}, '${project.name.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                hideLoading();
            } catch (error) {
                console.error('Error loading projects:', error);
                document.getElementById('projectsGrid').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle empty-state-icon" style="color: #ef4444;"></i>
                        <h3>Error loading projects</h3>
                        <p>${error.message}</p>
                    </div>
                `;
                hideLoading();
            }
        }

        // Delete project - store pending delete
        let pendingDelete = { id: null, name: '' };

        function deleteProject(id, name) {
            pendingDelete = { id, name };
            document.getElementById('confirmProjectName').textContent = name;
            document.getElementById('confirmProjectNameInput').textContent = name;
            document.getElementById('deleteConfirmInput').value = '';
            document.getElementById('confirmDeleteBtn').disabled = true;
            document.getElementById('confirmModal').classList.add('active');

            // Focus on the input field after a short delay to allow modal animation
            setTimeout(() => {
                document.getElementById('deleteConfirmInput').focus();
            }, 100);
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            document.getElementById('deleteConfirmInput').value = '';
            document.getElementById('confirmDeleteBtn').disabled = true;
            pendingDelete = { id: null, name: '' };
        }

        // Enable/disable delete button based on input
        document.addEventListener('DOMContentLoaded', () => {
            const deleteConfirmInput = document.getElementById('deleteConfirmInput');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

            deleteConfirmInput.addEventListener('input', (e) => {
                const inputValue = e.target.value.trim();
                if (inputValue === pendingDelete.name) {
                    confirmDeleteBtn.disabled = false;
                } else {
                    confirmDeleteBtn.disabled = true;
                }
            });
        });

        async function confirmDelete() {
            if (!pendingDelete.id) return;

            try {
                const response = await fetch(`${API_URL}/projects/${pendingDelete.id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to delete project');
                }

                closeConfirmModal();
                showSuccess('Project deleted successfully!');
                loadProjects();
            } catch (error) {
                closeConfirmModal();
                showError(error.message);
            }
        }

        function showSuccess(message) {
            const elem = document.getElementById('successMessage');
            const text = document.getElementById('successText');
            text.textContent = message;
            elem.classList.add('active');
            setTimeout(() => elem.classList.remove('active'), 3000);
        }

        function showError(message) {
            const elem = document.getElementById('errorMessage');
            const text = document.getElementById('errorText');
            text.textContent = message;
            elem.classList.add('active');
            setTimeout(() => elem.classList.remove('active'), 5000);
        }

        // Modal functions
        function openModal() {
            document.getElementById('createModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('createModal').classList.remove('active');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const createModal = document.getElementById('createModal');
            const confirmModal = document.getElementById('confirmModal');

            if (event.target === createModal) {
                closeModal();
            }
            if (event.target === confirmModal) {
                closeConfirmModal();
            }
        }

        // Load projects on page load
        loadProjects();
    </script>
</body>
</html>