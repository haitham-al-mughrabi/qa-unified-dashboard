<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Availability Statistics - QA Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/src/static/performance-statistics.css">
    <link rel="stylesheet" href="/src/static/navbar.css">
    <link rel="stylesheet" href="/src/static/nav-dropdown.css">
    <link rel="stylesheet" href="/src/static/footer.css">
    <link rel="stylesheet" href="/src/static/toast.css">
    <style>
        .main-container {
            max-width: 1400px !important;
            margin: 0 auto !important;
            padding: var(--spacing-2xl) var(--spacing-xl);
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container-redesigned">
            <!-- Logo/Icon on the left -->
            <a href="/dashboard.html" class="navbar-brand-left">
                <img src="src/logo/logo-only.png" alt="QA Analytics Logo">
            </a>

            <!-- Main Navigation Links -->
            <div class="navbar-links-main">
                <!-- Analyzer Dropdown -->
                <div class="nav-dropdown">
                    <button class="nav-btn dropdown-toggle">
                        <i class="fas fa-chart-pie"></i> Analyzer <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu">
                        <a href="/dashboard.html" class="dropdown-item">
                            <i class="fas fa-chart-bar"></i> Ticket Analysis
                        </a>
                        <a href="/" class="dropdown-item">
                            <i class="fas fa-file-alt"></i> Ticket Analyzer
                        </a>
                    </div>
                </div>

                <!-- Statistics Dropdown -->
                <div class="nav-dropdown">
                    <button class="nav-btn dropdown-toggle">
                        <i class="fas fa-chart-line"></i> Statistics <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu">
                        <a href="/performance-statistics" class="dropdown-item">
                            <i class="fas fa-trophy"></i> Performance Statistics
                        </a>
                        <a href="/performance-metrics-extractor" class="dropdown-item">
                            <i class="fas fa-file-export"></i> Performance Metrics Extractor
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="/project-statistics.html" class="dropdown-item">
                            <i class="fas fa-project-diagram"></i> Project Statistics
                        </a>
                        <a href="/portfolio-statistics.html" class="dropdown-item">
                            <i class="fas fa-briefcase"></i> Portfolio Statistics
                        </a>
                    </div>
                </div>

                <!-- Availability Dropdown -->
                <div class="nav-dropdown">
                    <button class="nav-btn dropdown-toggle">
                        <i class="fas fa-server"></i> Availability <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu">
                        <a href="/availability-statistics" class="dropdown-item">
                            <i class="fas fa-chart-area"></i> Availability Statistics
                        </a>
                        <a href="/availability-metrics-extractor" class="dropdown-item">
                            <i class="fas fa-file-export"></i> Availability Metrics Extractor
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="/project-availability" class="dropdown-item">
                            <i class="fas fa-project-diagram"></i> Availability Projects
                        </a>
                        <a href="/availability-dashboard" class="dropdown-item">
                            <i class="fas fa-briefcase"></i> Availability Portfolios
                        </a>
                    </div>
                </div>

                <a href="/settings" class="nav-btn"><i class="fas fa-cog"></i> Settings</a>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Hero Section -->
        <div class="hero">
            <h1><i class="fas fa-server"></i> Availability Statistics</h1>
            <p>Upload JSON or CSV files to analyze availability metrics by project and quarter (values as percentages)
            </p>
        </div>

        <!-- Upload Card -->
        <div class="upload-card">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon"><i class="fas fa-file-import"></i></div>
                <div class="upload-text">
                    <h3>Upload JSON or CSV Files</h3>
                    <p>Drag and drop one or more files here or click to browse</p>
                    <small>Expected format: [{"title": "ProjectName - Month:", "value": 95.5}] (values as
                        percentages)</small>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".json, .csv" multiple>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-upload"></i> Choose Files
                </button>
            </div>

            <!-- File Queue Display -->
            <div class="file-queue" id="fileQueue" style="display: none;">
                <div class="queue-header">
                    <h4><i class="fas fa-list"></i> Selected Files</h4>
                    <button class="btn-clear-queue" onclick="clearFileQueue()" title="Clear all files">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="queue-list" id="queueList"></div>
                <div class="queue-actions">
                    <button class="btn-cancel-queue" onclick="clearFileQueue()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn-process-queue" onclick="processFileQueue()">
                        <i class="fas fa-play"></i> Process Files
                    </button>
                </div>
            </div>

            <div class="file-name" id="fileName"></div>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <h3 id="loadingTitle">Processing your file...</h3>
            <p id="loadingText">This may take a moment</p>

            <!-- Progress Indicator -->
            <div class="file-progress" id="fileProgress" style="display: none;">
                <div class="progress-info">
                    <span id="progressCounter">0 of 0</span>
                    <span id="currentFileName" class="current-file"></span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBarFill"></div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <!-- Results Container -->
        <div class="results-container" id="resultsContainer"></div>
    </div>

    <!-- Save Modal -->
    <div class="modal" id="saveModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-save"></i> Save Availability Statistics</h2>
                <button class="modal-close" onclick="closeSaveModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Select which projects and data to save to the database:</p>

                <!-- Project Selection -->
                <div class="save-options" id="projectSelection"></div>

                <!-- Save All Toggle -->
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="selectAllProjects" onchange="toggleSelectAll()">
                        <span>Select All Projects</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeSaveModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn-save" onclick="saveSelectedData()">
                    <i class="fas fa-save"></i> Save Selected
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <div class="footer-top">
                <!-- Brand Column -->
                <div class="footer-column brand-column">
                    <div class="footer-logo">
                        <img src="src/logo/main_logo.png" alt="QA Analytics Logo">
                    </div>
                    <p class="footer-description">
                        Comprehensive quality assurance analytics and reporting dashboard for Takamol Holding.
                    </p>
                </div>

                <!-- Analyzer Column -->
                <div class="footer-column">
                    <h3>Analyzer</h3>
                    <ul class="footer-links">
                        <li><a href="/dashboard.html"><i class="fas fa-chart-bar"></i> Ticket Analysis</a></li>
                        <li><a href="/"><i class="fas fa-file-alt"></i> Ticket Analyzer</a></li>
                    </ul>
                </div>

                <!-- Statistics Column -->
                <div class="footer-column">
                    <h3>Statistics</h3>
                    <ul class="footer-links">
                        <li><a href="/performance-statistics"><i class="fas fa-trophy"></i> Performance Stats</a></li>
                        <li><a href="/project-statistics.html"><i class="fas fa-project-diagram"></i> Project Stats</a>
                        </li>
                        <li><a href="/portfolio-statistics.html"><i class="fas fa-briefcase"></i> Portfolio Stats</a>
                        </li>
                    </ul>
                </div>

                <!-- Availability Column -->
                <div class="footer-column">
                    <h3>Availability</h3>
                    <ul class="footer-links">
                        <li><a href="/availability-statistics"><i class="fas fa-chart-area"></i> Availability Stats</a>
                        </li>
                        <li><a href="/project-availability"><i class="fas fa-project-diagram"></i> Availability
                                Projects</a></li>
                        <li><a href="/availability-dashboard"><i class="fas fa-briefcase"></i> Availability
                                Portfolios</a></li>
                    </ul>
                </div>

                <!-- Settings Column -->
                <div class="footer-column">
                    <h3>General</h3>
                    <ul class="footer-links">
                        <li><a href="/settings"><i class="fas fa-cog"></i> Settings</a></li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <div class="footer-copyright">
                    <i class="fas fa-copyright"></i> <span id="year"></span> All Rights Reserved
                </div>
                <div class="footer-divider"></div>
                <div class="footer-developer">
                    <i class="fas fa-user-tie"></i> Developed by: <strong>Haitham Al Mughrabi</strong>
                </div>
                <div class="footer-divider"></div>
                <div class="footer-company">
                    <div class="footer-company-header">
                        <i class="fas fa-building"></i> <span class="footer-company-name">Takamol Holding</span>
                    </div>
                    <div class="footer-department"><i class="fas fa-check-circle"></i> Integrated Solutions | Quality
                        Assurance Unit</div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Set current year in footer
        document.getElementById('year').textContent = new Date().getFullYear();

        // Global variables
        let fileQueue = [];
        let currentFileIndex = 0;
        let allParsedData = [];
        let processedDataByProject = {};

        // Month to quarter mapping
        const monthToQuarter = {
            'january': 'Q1', 'february': 'Q1', 'march': 'Q1',
            'april': 'Q2', 'may': 'Q2', 'june': 'Q2',
            'july': 'Q3', 'august': 'Q3', 'september': 'Q3',
            'october': 'Q4', 'november': 'Q4', 'december': 'Q4',
            'jan': 'Q1', 'feb': 'Q1', 'mar': 'Q1',
            'apr': 'Q2', 'jun': 'Q2',
            'jul': 'Q3', 'aug': 'Q3', 'sep': 'Q3', 'sept': 'Q3',
            'oct': 'Q4', 'nov': 'Q4', 'dec': 'Q4'
        };

        // Month to number mapping for sorting
        const monthToNumber = {
            'january': 1, 'february': 2, 'march': 3,
            'april': 4, 'may': 5, 'june': 6,
            'july': 7, 'august': 8, 'september': 9,
            'october': 10, 'november': 11, 'december': 12,
            'jan': 1, 'feb': 2, 'mar': 3,
            'apr': 4, 'jun': 6,
            'jul': 7, 'aug': 8, 'sep': 9, 'sept': 9,
            'oct': 10, 'nov': 11, 'dec': 12
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            setupUploadHandlers();

            // Check if we have extracted metrics from the availability metrics extractor
            checkForExtractedMetrics();
        });

        function checkForExtractedMetrics() {
            // Check URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');

            if (mode === 'extracted') {
                // Try to get metrics from sessionStorage
                const extractedMetricsJson = sessionStorage.getItem('availabilityExtractedMetrics');

                if (extractedMetricsJson) {
                    try {
                        const extractedMetrics = JSON.parse(extractedMetricsJson);

                        console.log('=== LOADED EXTRACTED AVAILABILITY METRICS ===');
                        console.log('Metrics count:', extractedMetrics.length);
                        console.log('First metric:', extractedMetrics[0]);
                        console.log('==============================================');

                        // Clear from sessionStorage
                        sessionStorage.removeItem('availabilityExtractedMetrics');

                        // Convert to file-like format and process
                        processExtractedMetrics(extractedMetrics);
                    } catch (error) {
                        console.error('Error loading extracted availability metrics:', error);
                        showError('Failed to load extracted availability metrics: ' + error.message);
                    }
                } else {
                    showError('No extracted availability metrics found. Please extract metrics first.');
                }
            }
        }

        function processExtractedMetrics(metrics) {
            showLoading();
            document.getElementById('loadingTitle').textContent = 'Processing extracted availability metrics...';
            document.getElementById('loadingText').textContent = `Processing ${metrics.length} metrics`;

            // Reset data
            allParsedData = [];
            processedDataByProject = {};

            // Process each metric
            metrics.forEach(item => {
                if (!item.title || item.value === undefined || item.value === null) {
                    console.warn('Skipping invalid metric:', item);
                    return;
                }

                // Parse title to extract project and month
                const parsed = parseTitle(item.title);
                if (!parsed) {
                    console.warn('Could not parse title:', item.title);
                    return;
                }

                const { project, month, year } = parsed;
                const quarter = getQuarter(month);
                const value = parseFloat(item.value);

                if (!processedDataByProject[project]) {
                    processedDataByProject[project] = {
                        projectName: project,
                        months: [],
                        quarters: { 'Q1': [], 'Q2': [], 'Q3': [], 'Q4': [] },
                        years: {}
                    };
                }

                processedDataByProject[project].months.push({
                    month,
                    quarter,
                    year,
                    value,
                    filename: 'extracted-availability-metrics.json'
                });

                processedDataByProject[project].quarters[quarter].push(value);

                if (!processedDataByProject[project].years[year]) {
                    processedDataByProject[project].years[year] = {
                        months: [],
                        quarters: { 'Q1': [], 'Q2': [], 'Q3': [], 'Q4': [] }
                    };
                }

                processedDataByProject[project].years[year].months.push({
                    month,
                    quarter,
                    value
                });

                processedDataByProject[project].years[year].quarters[quarter].push(value);
            });

            hideLoading();

            const projectCount = Object.keys(processedDataByProject).length;
            if (projectCount > 0) {
                displayResults();
                showSuccess(`Successfully loaded ${metrics.length} availability metrics from ${projectCount} project(s)`);
            } else {
                showError('No valid metrics could be processed from the extracted data');
            }
        }

        function setupUploadHandlers() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            // Highlight drop area when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.add('drag-active'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('drag-active'), false);
            });

            // Handle dropped files
            uploadArea.addEventListener('drop', handleDrop, false);

            // Handle file input change
            fileInput.addEventListener('change', handleFileSelect, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            fileQueue = Array.from(files).filter(file => {
                const ext = file.name.split('.').pop().toLowerCase();
                return ext === 'json' || ext === 'csv';
            });

            if (fileQueue.length === 0) {
                showError('Please select valid JSON or CSV files');
                return;
            }

            displayFileQueue();
        }

        function displayFileQueue() {
            const queueList = document.getElementById('queueList');
            const fileQueueDiv = document.getElementById('fileQueue');

            queueList.innerHTML = '';

            fileQueue.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'queue-item';
                fileItem.innerHTML = `
                    <div class="queue-item-info">
                        <i class="fas fa-file"></i>
                        <span class="queue-item-name">${file.name}</span>
                        <span class="queue-item-size">(${formatFileSize(file.size)})</span>
                    </div>
                    <button class="queue-item-remove" onclick="removeFromQueue(${index})" title="Remove file">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                queueList.appendChild(fileItem);
            });

            fileQueueDiv.style.display = 'block';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        function removeFromQueue(index) {
            fileQueue.splice(index, 1);
            if (fileQueue.length === 0) {
                clearFileQueue();
            } else {
                displayFileQueue();
            }
        }

        function clearFileQueue() {
            fileQueue = [];
            document.getElementById('fileQueue').style.display = 'none';
            document.getElementById('fileInput').value = '';
            allParsedData = [];
            processedDataByProject = {};
            document.getElementById('resultsContainer').innerHTML = '';
            // document.getElementById('saveBtn').style.display = 'none'; // Removed as button is inside resultsContainer
        }

        async function processFileQueue() {
            if (fileQueue.length === 0) return;

            allParsedData = [];
            processedDataByProject = {};
            currentFileIndex = 0;

            document.getElementById('fileQueue').style.display = 'none';
            showLoading();

            const fileProgress = document.getElementById('fileProgress');
            const progressCounter = document.getElementById('progressCounter');
            const progressBarFill = document.getElementById('progressBarFill');

            if (fileQueue.length > 1) {
                fileProgress.style.display = 'block';
            }

            for (let i = 0; i < fileQueue.length; i++) {
                currentFileIndex = i + 1;

                if (fileQueue.length > 1) {
                    progressCounter.textContent = `File ${currentFileIndex} of ${fileQueue.length}`;
                    progressBarFill.style.width = `${(currentFileIndex / fileQueue.length) * 100}%`;
                }

                document.getElementById('currentFileName').textContent = fileQueue[i].name;

                try {
                    await processFile(fileQueue[i]);
                } catch (error) {
                    console.error(`Error processing ${fileQueue[i].name}:`, error);
                    showError(`Error processing ${fileQueue[i].name}: ${error.message}`);
                }
            }

            hideLoading();
            displayResults();
            // document.getElementById('saveBtn').style.display = 'block'; // Removed as button is created visible
            showSuccess(`Successfully processed ${fileQueue.length} file(s)`);
        }

        function processFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                const ext = file.name.split('.').pop().toLowerCase();

                reader.onload = function (e) {
                    try {
                        let data;

                        if (ext === 'json') {
                            data = JSON.parse(e.target.result);
                        } else if (ext === 'csv') {
                            const parsed = Papa.parse(e.target.result, { header: true, skipEmptyLines: true });
                            data = parsed.data;
                        }

                        if (!Array.isArray(data)) {
                            reject(new Error('Invalid file format. Expected an array of objects.'));
                            return;
                        }

                        // Process the data
                        data.forEach(item => {
                            if (!item.title || item.value === undefined) {
                                return;
                            }

                            // Parse title to extract project and month
                            const parsed = parseTitle(item.title);
                            if (!parsed) return;

                            const { project, month, year } = parsed;
                            const quarter = getQuarter(month);
                            const value = parseFloat(item.value);

                            if (!processedDataByProject[project]) {
                                processedDataByProject[project] = {
                                    projectName: project,
                                    months: [],
                                    quarters: { 'Q1': [], 'Q2': [], 'Q3': [], 'Q4': [] },
                                    years: {}
                                };
                            }

                            processedDataByProject[project].months.push({
                                month,
                                quarter,
                                year,
                                value,
                                filename: file.name
                            });

                            processedDataByProject[project].quarters[quarter].push(value);

                            if (!processedDataByProject[project].years[year]) {
                                processedDataByProject[project].years[year] = {
                                    months: [],
                                    quarters: { 'Q1': [], 'Q2': [], 'Q3': [], 'Q4': [] }
                                };
                            }

                            processedDataByProject[project].years[year].months.push({
                                month,
                                quarter,
                                value
                            });

                            processedDataByProject[project].years[year].quarters[quarter].push(value);
                        });

                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };

                reader.onerror = function () {
                    reject(new Error('Failed to read file'));
                };

                reader.readAsText(file);
            });
        }

        function parseTitle(title) {
            // Expected format: "ProjectName - Month:" or "ProjectName - Month Year:"
            const parts = title.split('–').length > 1 ? title.split('–') : title.split('-');

            if (parts.length < 2) return null;

            const project = parts[0].trim();
            const monthPart = parts[1].trim().replace(':', '').trim();

            // Extract month and optional year
            const monthWords = monthPart.split(/\s+/);
            const month = monthWords[0].toLowerCase();
            const year = monthWords[1] ? parseInt(monthWords[1]) : new Date().getFullYear();

            if (!monthToQuarter[month]) return null;

            return { project, month, year };
        }

        function getQuarter(month) {
            return monthToQuarter[month.toLowerCase()] || null;
        }

        function calculateAverage(values) {
            if (values.length === 0) return 0;
            const sum = values.reduce((a, b) => a + b, 0);
            return parseFloat((sum / values.length).toFixed(2));
        }

        function displayResults() {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '';

            const projectNames = Object.keys(processedDataByProject).sort();

            if (projectNames.length === 0) {
                return;
            }

            // Create Tabs Container
            const tabsContainer = document.createElement('div');
            tabsContainer.className = 'tabs-container';

            // Create Tabs Header
            const tabsHeader = document.createElement('div');
            tabsHeader.className = 'tabs-header';

            // Create Tabs Content Area
            const tabsContent = document.createElement('div');
            tabsContent.className = 'tab-content';

            projectNames.forEach((projectName, index) => {
                // Create Tab Button
                const tabBtn = document.createElement('button');
                tabBtn.className = `tab-btn ${index === 0 ? 'active' : ''}`;
                tabBtn.innerHTML = `<i class="fas fa-project-diagram"></i> ${projectName}`;
                tabBtn.onclick = () => switchTab(projectName);
                tabBtn.dataset.tab = projectName;
                tabsHeader.appendChild(tabBtn);

                // Create Tab Pane
                const projectData = processedDataByProject[projectName];
                const tabPane = document.createElement('div');
                tabPane.className = `tab-pane ${index === 0 ? 'active' : ''}`;
                tabPane.id = `tab-${projectName.replace(/\s+/g, '-')}`;

                // Generate content for the project
                tabPane.appendChild(createProjectContent(projectName, projectData));
                tabsContent.appendChild(tabPane);
            });

            tabsContainer.appendChild(tabsHeader);
            tabsContainer.appendChild(tabsContent);
            resultsContainer.appendChild(tabsContainer);

            // Add Save Button
            const saveButtonContainer = document.createElement('div');
            saveButtonContainer.className = 'save-button-container';
            saveButtonContainer.style.cssText = 'text-align: center; margin-top: 2rem; padding: 1.5rem;';
            saveButtonContainer.innerHTML = `
                <button onclick="openSaveModal()" class="btn-save-main" style="
                    padding: 1rem 2.5rem;
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white;
                    border: none;
                    border-radius: 12px;
                    font-size: 1.125rem;
                    font-weight: 700;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    transition: all 0.3s ease;
                    display: inline-flex;
                    align-items: center;
                    gap: 0.75rem;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.4)'"
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
                    <i class="fas fa-save" style="font-size: 1.25rem;"></i>
                    <span>Save to Database</span>
                </button>
                <p style="margin-top: 1rem; color: var(--gray-600); font-size: 0.875rem;">
                    Click to select which projects to save
                </p>
            `;
            resultsContainer.appendChild(saveButtonContainer);
        }

        function switchTab(projectName) {
            // Update Tab Buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.dataset.tab === projectName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Update Tab Panes
            const targetId = `tab-${projectName.replace(/\s+/g, '-')}`;
            document.querySelectorAll('.tab-pane').forEach(pane => {
                if (pane.id === targetId) {
                    pane.classList.add('active');
                } else {
                    pane.classList.remove('active');
                }
            });
        }

        function createProjectContent(projectName, projectData) {
            const container = document.createElement('div');

            // Sort months by month order
            projectData.months.sort((a, b) => {
                if (a.year !== b.year) return a.year - b.year;
                return (monthToNumber[a.month.toLowerCase()] || 0) - (monthToNumber[b.month.toLowerCase()] || 0);
            });

            // Calculate quarterly averages
            const quarterlyAverages = {};
            Object.keys(projectData.quarters).forEach(quarter => {
                quarterlyAverages[quarter] = calculateAverage(projectData.quarters[quarter]);
            });

            // Group by year
            const yearGroups = {};
            projectData.months.forEach(item => {
                if (!yearGroups[item.year]) {
                    yearGroups[item.year] = {
                        months: [],
                        quarters: { 'Q1': [], 'Q2': [], 'Q3': [], 'Q4': [] }
                    };
                }
                yearGroups[item.year].months.push(item);
                yearGroups[item.year].quarters[item.quarter].push(item.value);
            });

            let html = `
                <div class="project-card">
                    <div class="project-card-header">
                        <h2><i class="fas fa-chart-line"></i> ${projectName} Statistics</h2>
                        <div class="project-stats">
                            <span class="stat-badge"><i class="fas fa-calendar"></i> ${projectData.months.length} months</span>
                        </div>
                    </div>
            `;

            // Display by year
            Object.keys(yearGroups).sort((a, b) => b - a).forEach(year => {
                const yearData = yearGroups[year];

                html += `
                    <div class="year-section">
                        <h3 class="year-title"><i class="fas fa-calendar-alt"></i> ${year}</h3>
                        <div class="months-grid">
                `;

                yearData.months.forEach(item => {
                    html += `
                        <div class="month-card">
                            <div class="month-name">${capitalize(item.month)}</div>
                            <div class="month-quarter">${item.quarter}</div>
                            <div class="month-value">${item.value.toFixed(2)}</div>
                        </div>
                    `;
                });

                html += `</div>`;

                // Quarterly averages for this year
                const yearQuarterAverages = {};
                Object.keys(yearData.quarters).forEach(quarter => {
                    yearQuarterAverages[quarter] = calculateAverage(yearData.quarters[quarter]);
                });

                html += `
                    <div class="quarterly-summary">
                        <h4><i class="fas fa-chart-bar"></i> Quarterly Averages</h4>
                        <div class="quarters-grid">
                `;

                ['Q1', 'Q2', 'Q3', 'Q4'].forEach(quarter => {
                    const avg = yearQuarterAverages[quarter];
                    const hasData = yearData.quarters[quarter].length > 0;
                    html += `
                        <div class="quarter-card ${!hasData ? 'no-data' : ''}">
                            <div class="quarter-name">${quarter}</div>
                            <div class="quarter-value">${hasData ? avg.toFixed(2) : 'N/A'}</div>
                            ${hasData ? `<div class="quarter-count">${yearData.quarters[quarter].length} months</div>` : ''}
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                </div>
                `;
            });

            html += `</div>`; // Close project-card
            container.innerHTML = html;
            return container;
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Save Modal Functions
        function openSaveModal() {
            const projectSelection = document.getElementById('projectSelection');
            projectSelection.innerHTML = '';

            Object.keys(processedDataByProject).sort().forEach(projectName => {
                const projectData = processedDataByProject[projectName];
                const div = document.createElement('div');
                div.className = 'project-option';
                div.innerHTML = `
                    <label class="checkbox-label">
                        <input type="checkbox" class="project-checkbox" value="${projectName}" checked>
                        <span><strong>${projectName}</strong> - ${projectData.months.length} months</span>
                    </label>
                `;
                projectSelection.appendChild(div);
            });

            document.getElementById('saveModal').classList.add('show');
        }

        function closeSaveModal() {
            document.getElementById('saveModal').classList.remove('show');
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllProjects');
            const checkboxes = document.querySelectorAll('.project-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        async function saveSelectedData() {
            const selectedProjects = Array.from(document.querySelectorAll('.project-checkbox:checked'))
                .map(cb => cb.value);

            if (selectedProjects.length === 0) {
                showError('Please select at least one project to save');
                return;
            }

            // Fetch projects from API to get project IDs
            try {
                showLoading();
                closeSaveModal();

                const response = await fetch('/api/projects');
                const { projects } = await response.json();

                // Create a map of project names to IDs
                const projectMap = {};
                projects.forEach(p => {
                    projectMap[p.name] = p.id;
                });

                // Prepare records to save
                const records = [];

                selectedProjects.forEach(projectName => {
                    const projectData = processedDataByProject[projectName];
                    const projectId = projectMap[projectName];

                    projectData.months.forEach(item => {
                        records.push({
                            project_id: projectId || null,
                            project_name: projectName,
                            year: item.year,
                            quarter: item.quarter,
                            month: item.month,
                            value: item.value,
                            filename: item.filename
                        });
                    });
                });

                // Save to database
                const saveResponse = await fetch('/api/availability-statistics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ records })
                });

                const result = await saveResponse.json();

                hideLoading();

                if (saveResponse.ok) {
                    showSuccess(result.message || 'Data saved successfully!');
                } else {
                    showError(result.error || 'Failed to save data');
                }
            } catch (error) {
                hideLoading();
                showError('Error saving data: ' + error.message);
            }
        }

        // Utility Functions
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('fileProgress').style.display = 'none';
        }

        // showSuccess and showError are now provided by toast.js
    </script>
    <script src="/src/static/toast.js"></script>



    <script>
        // Dropdown functionality
        document.addEventListener('DOMContentLoaded', function () {
            const dropdowns = document.querySelectorAll('.nav-dropdown');

            dropdowns.forEach(dropdown => {
                const toggle = dropdown.querySelector('.dropdown-toggle');

                toggle.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Close other dropdowns
                    dropdowns.forEach(d => {
                        if (d !== dropdown) {
                            d.classList.remove('active');
                        }
                    });

                    // Toggle current dropdown
                    dropdown.classList.toggle('active');
                });
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function () {
                dropdowns.forEach(dropdown => {
                    dropdown.classList.remove('active');
                });
            });

            // Prevent dropdown from closing when clicking inside it
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.addEventListener('click', function (e) {
                    e.stopPropagation();
                });
            });
        });
    </script>
</body>

</html>