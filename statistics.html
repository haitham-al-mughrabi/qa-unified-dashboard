<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistics - QA Analytics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="src/static/dashboard.css">
    <link rel="stylesheet" href="src/static/statistics.css">
    <link rel="stylesheet" href="/src/static/nav-dropdown.css">
    <link rel="stylesheet" href="src/static/footer.css">
    <link rel="stylesheet" href="/src/static/toast.css">
    <link rel="stylesheet" href="/src/static/navbar.css">
</head>

<body>
    <!-- Navigation -->
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container-redesigned">
            <!-- Logo/Icon on the left -->
            <a href="/dashboard.html" class="navbar-brand-left">
                <div class="navbar-brand-icon"><i class="fas fa-line-chart"></i></div>
                <span class="navbar-brand-text">QA Analytics</span>
            </a>

            <!-- Main Navigation Links -->
            <div class="navbar-links-main">
                <!-- Analyzer Dropdown -->
                <div class="nav-dropdown">
                    <button class="nav-btn dropdown-toggle">
                        <i class="fas fa-chart-pie"></i> Analyzer <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu">
                        <a href="/dashboard.html" class="dropdown-item">
                            <i class="fas fa-chart-bar"></i> Ticket Analysis
                        </a>
                        <a href="/" class="dropdown-item">
                            <i class="fas fa-file-alt"></i> Ticket Analyzer
                        </a>
                    </div>
                </div>

                <!-- Statistics Dropdown -->
                <div class="nav-dropdown">
                    <button class="nav-btn dropdown-toggle">
                        <i class="fas fa-chart-line"></i> Statistics <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu">
                        <a href="/performance-statistics" class="dropdown-item">
                            <i class="fas fa-trophy"></i> Performance Statistics
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="/project-statistics.html" class="dropdown-item">
                            <i class="fas fa-project-diagram"></i> Project Statistics
                        </a>
                        <a href="/portfolio-statistics.html" class="dropdown-item">
                            <i class="fas fa-briefcase"></i> Portfolio Statistics
                        </a>
                    </div>
                </div>

                <!-- Availability Dropdown -->
                <div class="nav-dropdown">
                    <button class="nav-btn dropdown-toggle">
                        <i class="fas fa-server"></i> Availability <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu">
                        <a href="/availability-statistics" class="dropdown-item">
                            <i class="fas fa-chart-area"></i> Availability Statistics
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="/project-availability" class="dropdown-item">
                            <i class="fas fa-project-diagram"></i> Availability Projects
                        </a>
                        <a href="/availability-dashboard" class="dropdown-item">
                            <i class="fas fa-briefcase"></i> Availability Portfolios
                        </a>
                    </div>
                </div>

                <a href="/settings" class="nav-btn"><i class="fas fa-cog"></i> Settings</a>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Hero -->
        <div class="hero">
            <h1><i class="fas fa-chart-pie"></i> <span id="heroTitle">Statistics & Analytics</span></h1>
            <p id="heroSubtitle">Select a project to view detailed analytics and compare performance across different
                time periods</p>
        </div>

        <!-- Selected Project Info -->
        <div id="selectedProjectInfo"
            style="display: none; background: white; border-radius: var(--radius-2xl); padding: var(--spacing-lg); margin-bottom: var(--spacing-2xl); box-shadow: var(--shadow-md); border: 1px solid var(--gray-200);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="margin: 0; color: var(--primary); font-size: 1.25rem;">
                        <i class="fas fa-folder-open"></i> <span id="selectedProjectName"></span>
                    </h3>
                    <p style="margin: 0.5rem 0 0 0; color: var(--gray-600);" id="selectedProjectDescription"></p>
                </div>
                <button class="btn-filter" onclick="openProjectModal()" style="padding: 0.75rem 1.5rem;">
                    <i class="fas fa-exchange-alt"></i> Change Project
                </button>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section" id="filtersSection" style="display: none;">
            <div style="width: 100%; margin-bottom: var(--spacing-lg);">
                <h3 style="margin: 0 0 var(--spacing-md) 0; color: var(--primary); font-size: 1.125rem;">
                    <i class="fas fa-sliders-h"></i> Time Period Comparison
                </h3>
            </div>

            <!-- Primary Period -->
            <div
                style="flex: 1; min-width: 100%; border: 2px solid var(--primary); border-radius: var(--radius-xl); padding: var(--spacing-lg); background: rgba(79, 70, 229, 0.05);">
                <h4
                    style="margin: 0 0 var(--spacing-md) 0; color: var(--primary); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.875rem;">
                    <i class="fas fa-calendar-check"></i> Primary Period
                </h4>
                <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
                    <div class="filter-group" style="flex: 1; min-width: 150px;">
                        <label class="filter-label">
                            <i class="fas fa-calendar-alt"></i> Year
                        </label>
                        <select id="primaryYear" class="filter-select">
                            <option value="">All Years</option>
                        </select>
                    </div>
                    <div class="filter-group" style="flex: 1; min-width: 150px;">
                        <label class="filter-label">
                            <i class="fas fa-calendar"></i> Quarter
                        </label>
                        <select id="primaryQuarter" class="filter-select">
                            <option value="">All Quarters</option>
                            <option value="Q1">Q1 (Jan-Mar)</option>
                            <option value="Q2">Q2 (Apr-Jun)</option>
                            <option value="Q3">Q3 (Jul-Sep)</option>
                            <option value="Q4">Q4 (Oct-Dec)</option>
                        </select>
                    </div>
                    <div class="filter-group" style="flex: 1; min-width: 150px;">
                        <label class="filter-label">
                            <i class="fas fa-calendar-day"></i> Month
                        </label>
                        <select id="primaryMonth" class="filter-select">
                            <option value="">All Months</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Comparison Toggle -->
            <div style="width: 100%; display: flex; align-items: center; gap: var(--spacing-md);">
                <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                    <input type="checkbox" id="enableComparison" onchange="toggleComparison()"
                        style="width: 1.25rem; height: 1.25rem; cursor: pointer;">
                    <span style="font-weight: 600; color: var(--gray-700);">Enable Comparison</span>
                </label>
            </div>

            <!-- Comparison Period -->
            <div id="comparisonPeriodSection"
                style="flex: 1; min-width: 100%; border: 2px solid var(--secondary); border-radius: var(--radius-xl); padding: var(--spacing-lg); background: rgba(16, 185, 129, 0.05); display: none;">
                <h4
                    style="margin: 0 0 var(--spacing-md) 0; color: var(--secondary); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.875rem;">
                    <i class="fas fa-calendar-plus"></i> Comparison Period
                </h4>
                <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
                    <div class="filter-group" style="flex: 1; min-width: 150px;">
                        <label class="filter-label">
                            <i class="fas fa-calendar-alt"></i> Year
                        </label>
                        <select id="compareYear" class="filter-select">
                            <option value="">All Years</option>
                        </select>
                    </div>
                    <div class="filter-group" style="flex: 1; min-width: 150px;">
                        <label class="filter-label">
                            <i class="fas fa-calendar"></i> Quarter
                        </label>
                        <select id="compareQuarter" class="filter-select">
                            <option value="">All Quarters</option>
                            <option value="Q1">Q1 (Jan-Mar)</option>
                            <option value="Q2">Q2 (Apr-Jun)</option>
                            <option value="Q3">Q3 (Jul-Sep)</option>
                            <option value="Q4">Q4 (Oct-Dec)</option>
                        </select>
                    </div>
                    <div class="filter-group" style="flex: 1; min-width: 150px;">
                        <label class="filter-label">
                            <i class="fas fa-calendar-day"></i> Month
                        </label>
                        <select id="compareMonth" class="filter-select">
                            <option value="">All Months</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Apply Button -->
            <div class="filter-actions" style="width: 100%; justify-content: center;">
                <button class="btn-filter" onclick="applyFilters()" style="padding: 1rem 3rem; font-size: 1rem;">
                    <i class="fas fa-chart-line"></i> Load Statistics
                </button>
                <button class="btn-export" onclick="exportReport()">
                    <i class="fas fa-download"></i> Export Report
                </button>
            </div>
        </div>

        <!-- Statistics Content (Hidden until data is loaded) -->
        <div id="statisticsContent" style="display: none;">
            <!-- Stats Cards -->
            <div class="stats-cards-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Total Tickets</h3>
                        <p class="stat-value" id="totalTickets">0</p>
                        <span class="stat-change" id="totalTicketsChange"></span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Resolved in 2 Days</h3>
                        <p class="stat-value" id="resolvedIn2Days">0</p>
                        <span class="stat-change" id="resolvedIn2DaysChange"></span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Resolved After 2 Days</h3>
                        <p class="stat-value" id="resolvedAfter2Days">0</p>
                        <span class="stat-change" id="resolvedAfter2DaysChange"></span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Success Rate</h3>
                        <p class="stat-value" id="successRate">0%</p>
                        <span class="stat-change" id="successRateChange"></span>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-header">
                        <h2><i class="fas fa-chart-bar"></i> Period Comparison</h2>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h2><i class="fas fa-chart-pie"></i> Resolution Breakdown</h2>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="resolutionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Additional Charts -->
            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-header">
                        <h2><i class="fas fa-chart-line"></i> Monthly Trend</h2>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h2><i class="fas fa-chart-area"></i> Success Rate Comparison</h2>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="successRateChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Statistics Table -->
            <div class="detailed-stats-section">
                <div class="section-header">
                    <h2><i class="fas fa-table"></i> Detailed Monthly Statistics</h2>
                    <p>Complete breakdown of all metrics for the selected period</p>
                </div>

                <div class="stats-table-wrapper">
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar"></i> Month</th>
                                <th><i class="fas fa-tasks"></i> Total Tickets</th>
                                <th><i class="fas fa-check"></i> Resolved in 2 Days</th>
                                <th><i class="fas fa-clock"></i> Resolved After 2 Days</th>
                                <th><i class="fas fa-percentage"></i> Success Rate</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableBody">
                            <tr>
                                <td colspan="5"
                                    style="text-align: center; padding: var(--spacing-lg); color: var(--gray-500);">
                                    No data available. Please select filters and load statistics.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading">
            <div class="spinner"></div>
            <h3>Loading statistics...</h3>
            <p>Please wait</p>
        </div>
    </div>

    <!-- Project Selection Modal -->
    <div class="modal modal-project" id="projectModal" style="display: flex;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2><i class="fas fa-folder-open"></i> Select Project</h2>
                <button class="close-btn" onclick="closeProjectModal()" id="closeModalBtn" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                <div class="projects-grid" id="projectsGrid">
                    <div style="grid-column: 1 / -1; text-align: center; padding: var(--spacing-2xl);">
                        <div class="spinner" style="margin: 0 auto var(--spacing-lg);"></div>
                        <p style="color: var(--gray-600);">Loading projects...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-top">
            <div class="footer-column brand-column">
                <img src="src/logo/main_logo.png" alt="QA Analytics Logo" class="footer-logo">
                <p class="footer-description">Comprehensive QA analytics and performance tracking for quality assurance
                    teams.</p>
            </div>
            <div class="footer-column">
                <h4>Analyzer</h4>
                <ul class="footer-links">
                    <li><a href="/dashboard.html"><i class="fas fa-chart-bar"></i> Ticket Analysis</a></li>
                    <li><a href="/"><i class="fas fa-file-alt"></i> Ticket Analyzer</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h4>Statistics</h4>
                <ul class="footer-links">
                    <li><a href="/performance-statistics"><i class="fas fa-trophy"></i> Performance Statistics</a></li>
                    <li><a href="/project-statistics.html"><i class="fas fa-project-diagram"></i> Project Statistics</a>
                    </li>
                    <li><a href="/portfolio-statistics.html"><i class="fas fa-briefcase"></i> Portfolio Statistics</a>
                    </li>
                </ul>
            </div>
            <div class="footer-column">
                <h4>Availability</h4>
                <ul class="footer-links">
                    <li><a href="/availability-statistics"><i class="fas fa-chart-area"></i> Availability Statistics</a>
                    </li>
                    <li><a href="/project-availability"><i class="fas fa-project-diagram"></i> Availability Projects</a>
                    </li>
                    <li><a href="/availability-dashboard"><i class="fas fa-briefcase"></i> Availability Portfolios</a>
                    </li>
                </ul>
            </div>
            <div class="footer-column">
                <h4>General</h4>
                <ul class="footer-links">
                    <li><a href="/projects.html"><i class="fas fa-folder"></i> Projects</a></li>
                    <li><a href="/portfolios"><i class="fas fa-briefcase"></i> Portfolios</a></li>
                    <li><a href="/settings"><i class="fas fa-cog"></i> Settings</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="footer-bottom-content">
                <div class="footer-copyright">
                    <i class="fas fa-copyright"></i> <span id="year"></span> All Rights Reserved
                </div>
                <div class="footer-divider"></div>
                <div class="footer-developer">
                    <i class="fas fa-user-tie"></i> Developed by: <strong>Haitham Al Mughrabi</strong>
                </div>
                <div class="footer-divider"></div>
                <div class="footer-company">
                    <div class="footer-company-header">
                        <i class="fas fa-building"></i> <span class="footer-company-name">Takamol Holding</span>
                    </div>
                    <div class="footer-department"><i class="fas fa-check-circle"></i> Integrated Solutions | Quality
                        Assurance Unit</div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Dynamically construct API URL based on current domain (works with localhost, ngrok, etc.)
        const API_URL = `${window.location.protocol}//${window.location.host}/api`;

        let selectedProject = null;
        let allProjects = [];
        let availableYears = new Set();

        // Chart instances
        let comparisonChartInstance = null;
        let resolutionChartInstance = null;
        let trendChartInstance = null;
        let successRateChartInstance = null;

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Helper function to safely parse JSON responses
        async function fetchJSON(url, options = {}) {
            try {
                const response = await fetch(url, options);

                // Check if response is OK (status 200-299)
                if (!response.ok) {
                    // Try to get error message from response
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const errorData = await response.json();
                            errorMessage = errorData.error || errorData.message || errorMessage;
                        } else {
                            const text = await response.text();
                            // If it's HTML, don't include the full HTML in the error
                            if (text.startsWith('<!DOCTYPE') || text.startsWith('<html')) {
                                errorMessage = `Server returned HTML error page (${response.status}). The API endpoint may not exist or the server encountered an error.`;
                            } else {
                                errorMessage = text || errorMessage;
                            }
                        }
                    } catch (e) {
                        // If we can't parse the error, use the default message
                    }
                    throw new Error(errorMessage);
                }

                // Check content-type before parsing JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    if (text.startsWith('<!DOCTYPE') || text.startsWith('<html')) {
                        throw new Error('Server returned HTML instead of JSON. The API endpoint may not exist or the server is not running.');
                    }
                    throw new Error('Server did not return JSON. Received content-type: ' + (contentType || 'unknown'));
                }

                return await response.json();
            } catch (error) {
                // Re-throw with more context if it's a network error
                if (error.message === 'Failed to fetch' || error.name === 'TypeError') {
                    throw new Error('Cannot connect to API server. Please ensure the server is running at ' + API_URL);
                }
                throw error;
            }
        }

        // Load projects on page load
        async function loadProjects() {
            try {
                const data = await fetchJSON(`${API_URL}/projects`);

                allProjects = data.projects || [];

                if (allProjects.length === 0) {
                    document.getElementById('projectsGrid').innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: var(--spacing-2xl);">
                            <i class="fas fa-folder-open" style="font-size: 3rem; color: var(--gray-400); margin-bottom: var(--spacing-lg);"></i>
                            <h3 style="color: var(--gray-600); margin-bottom: var(--spacing-sm);">No Projects Found</h3>
                            <p style="color: var(--gray-500);">Please create a project first to view statistics.</p>
                            <a href="/portfolios" class="nav-btn"><i class="fas fa-briefcase"></i> Portfolios</a>
                <a href="/projects.html" class="btn-filter" style="margin-top: var(--spacing-lg); display: inline-flex; text-decoration: none;">
                                <i class="fas fa-plus"></i> Create Project
                            </a>
                        </div>
                    `;
                    return;
                }

                loadProjectsModal();
            } catch (error) {
                console.error('Error loading projects:', error);
                document.getElementById('projectsGrid').innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: var(--spacing-2xl); color: var(--danger);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: var(--spacing-lg);"></i>
                        <h3>Error Loading Projects</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Load projects into modal
        function loadProjectsModal() {
            const projectsGrid = document.getElementById('projectsGrid');
            let html = '';

            allProjects.forEach(project => {
                html += `
                    <div class="project-card-modal" onclick="selectProject(${project.id}, '${escapeHtml(project.name)}', '${escapeHtml(project.description || '')}')">
                        <div class="project-card-header">
                            <i class="fas fa-folder"></i>
                        </div>
                        <h3>${escapeHtml(project.name)}</h3>
                        <p>${escapeHtml(project.description || 'No description')}</p>
                        <div class="project-meta">
                            <span><i class="fas fa-calendar"></i> ${new Date(project.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                `;
            });

            projectsGrid.innerHTML = html;
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Select project
        async function selectProject(projectId, projectName, projectDescription) {
            selectedProject = {
                id: projectId,
                name: projectName,
                description: projectDescription
            };

            // Update UI
            document.getElementById('heroTitle').textContent = `${projectName} Statistics`;
            document.getElementById('heroSubtitle').textContent = `Detailed analytics and performance comparison for ${projectName}`;
            document.getElementById('selectedProjectName').textContent = projectName;
            document.getElementById('selectedProjectDescription').textContent = projectDescription || 'No description available';
            document.getElementById('selectedProjectInfo').style.display = 'block';
            document.getElementById('filtersSection').style.display = 'flex';

            // Close modal and enable close button
            closeProjectModal();
            document.getElementById('closeModalBtn').style.display = 'flex';

            // Load available years for this project
            await loadAvailableYears(projectId);
        }

        // Load available years for the selected project
        async function loadAvailableYears(projectId) {
            try {
                const data = await fetchJSON(`${API_URL}/records/project/${projectId}`);

                availableYears.clear();
                data.records.forEach(record => {
                    availableYears.add(record.year);
                });

                // Populate year dropdowns
                const years = Array.from(availableYears).sort((a, b) => b - a);
                const primaryYearSelect = document.getElementById('primaryYear');
                const compareYearSelect = document.getElementById('compareYear');

                primaryYearSelect.innerHTML = '<option value="">All Years</option>';
                compareYearSelect.innerHTML = '<option value="">All Years</option>';

                years.forEach(year => {
                    primaryYearSelect.innerHTML += `<option value="${year}">${year}</option>`;
                    compareYearSelect.innerHTML += `<option value="${year}">${year}</option>`;
                });

                // Set default to current year if available
                const currentYear = new Date().getFullYear();
                if (years.includes(currentYear)) {
                    primaryYearSelect.value = currentYear;
                }
            } catch (error) {
                console.error('Error loading available years:', error);
            }
        }

        // Open project selection modal
        function openProjectModal() {
            document.getElementById('projectModal').style.display = 'flex';
        }

        // Close project selection modal
        function closeProjectModal() {
            // Only allow closing if a project is selected
            if (selectedProject) {
                document.getElementById('projectModal').style.display = 'none';
            }
        }

        // Toggle comparison section
        function toggleComparison() {
            const enabled = document.getElementById('enableComparison').checked;
            document.getElementById('comparisonPeriodSection').style.display = enabled ? 'flex' : 'none';
        }

        // Apply filters and load statistics
        async function applyFilters() {
            if (!selectedProject) {
                alert('Please select a project first');
                return;
            }

            const primaryYear = document.getElementById('primaryYear').value;
            const primaryQuarter = document.getElementById('primaryQuarter').value;
            const primaryMonth = document.getElementById('primaryMonth').value;

            const enableComparison = document.getElementById('enableComparison').checked;
            const compareYear = enableComparison ? document.getElementById('compareYear').value : '';
            const compareQuarter = enableComparison ? document.getElementById('compareQuarter').value : '';
            const compareMonth = enableComparison ? document.getElementById('compareMonth').value : '';

            // Build query parameters
            let queryParams = `projectId=${selectedProject.id}`;
            if (primaryYear) queryParams += `&primaryYear=${primaryYear}`;
            if (primaryQuarter) queryParams += `&primaryQuarter=${primaryQuarter}`;
            if (primaryMonth) queryParams += `&primaryMonth=${primaryMonth}`;

            if (enableComparison) {
                if (compareYear) queryParams += `&compareYear=${compareYear}`;
                if (compareQuarter) queryParams += `&compareQuarter=${compareQuarter}`;
                if (compareMonth) queryParams += `&compareMonth=${compareMonth}`;
            }

            showLoading();

            try {
                const data = await fetchJSON(`${API_URL}/statistics/compare?${queryParams}`);

                if (data.success) {
                    updateStatistics(data);
                    document.getElementById('statisticsContent').style.display = 'block';
                } else {
                    alert('Error loading statistics: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
                alert('Error loading statistics: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Update statistics with loaded data
        function updateStatistics(data) {
            const primary = data.primary;
            const compare = data.compare;
            const changes = data.changes;

            // Update stat cards
            document.getElementById('totalTickets').textContent = primary.totalTickets;
            document.getElementById('resolvedIn2Days').textContent = primary.resolvedIn2Days;
            document.getElementById('resolvedAfter2Days').textContent = primary.resolvedAfter2Days;
            document.getElementById('successRate').textContent = primary.successRate + '%';

            // Update change indicators
            if (changes) {
                updateChangeIndicator('totalTicketsChange', changes.totalTickets, changes.totalTicketsPercent);
                updateChangeIndicator('resolvedIn2DaysChange', changes.resolvedIn2Days, changes.resolvedIn2DaysPercent);
                updateChangeIndicator('resolvedAfter2DaysChange', changes.resolvedIn2Days * -1, changes.resolvedIn2DaysPercent);
                updateChangeIndicator('successRateChange', changes.successRate, changes.successRate, '%');
            } else {
                // Hide change indicators
                document.getElementById('totalTicketsChange').textContent = '';
                document.getElementById('resolvedIn2DaysChange').textContent = '';
                document.getElementById('resolvedAfter2DaysChange').textContent = '';
                document.getElementById('successRateChange').textContent = '';
            }

            // Update charts
            updateComparisonChart(primary, compare);
            updateResolutionChart(primary);
            updateTrendChart(primary.records);
            updateSuccessRateChart(primary, compare);

            // Update detailed table
            updateStatsTable(primary.records);
        }

        // Update change indicator
        function updateChangeIndicator(elementId, change, changePercent, suffix = '') {
            const element = document.getElementById(elementId);

            if (change > 0) {
                element.className = 'stat-change positive';
                element.textContent = `↑ ${change} (${changePercent}${suffix}) from comparison period`;
            } else if (change < 0) {
                element.className = 'stat-change negative';
                element.textContent = `↓ ${Math.abs(change)} (${Math.abs(changePercent)}${suffix}) from comparison period`;
            } else {
                element.className = 'stat-change';
                element.textContent = `No change from comparison period`;
            }
        }

        // Update comparison chart
        function updateComparisonChart(primary, compare) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');

            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
            }

            const datasets = [{
                label: 'Primary Period',
                data: [primary.totalTickets, primary.resolvedIn2Days, primary.resolvedAfter2Days],
                backgroundColor: 'rgba(79, 70, 229, 0.8)',
                borderColor: 'rgb(79, 70, 229)',
                borderWidth: 2,
                borderRadius: 4
            }];

            if (compare) {
                datasets.push({
                    label: 'Comparison Period',
                    data: [compare.totalTickets, compare.resolvedIn2Days, compare.resolvedAfter2Days],
                    backgroundColor: 'rgba(16, 185, 129, 0.8)',
                    borderColor: 'rgb(16, 185, 129)',
                    borderWidth: 2,
                    borderRadius: 4
                });
            }

            comparisonChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Total Tickets', 'Resolved in 2 Days', 'Resolved After 2 Days'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 12, weight: 600 },
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        }
                    }
                }
            });
        }

        // Update resolution chart
        function updateResolutionChart(primary) {
            const ctx = document.getElementById('resolutionChart').getContext('2d');

            if (resolutionChartInstance) {
                resolutionChartInstance.destroy();
            }

            resolutionChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Resolved in 2 Days', 'Resolved After 2 Days'],
                    datasets: [{
                        data: [primary.resolvedIn2Days, primary.resolvedAfter2Days],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            'rgb(16, 185, 129)',
                            'rgb(245, 158, 11)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 12, weight: 600 },
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // Update trend chart
        function updateTrendChart(records) {
            const ctx = document.getElementById('trendChart').getContext('2d');

            if (trendChartInstance) {
                trendChartInstance.destroy();
            }

            // Group by month and sort
            const monthlyData = {};
            records.forEach(record => {
                const key = record.displayName || `${record.year}-${record.month}`;
                if (!monthlyData[key]) {
                    monthlyData[key] = {
                        totalTickets: 0,
                        resolvedIn2Days: 0
                    };
                }
                monthlyData[key].totalTickets += record.total_tickets || 0;
                monthlyData[key].resolvedIn2Days += record.resolved_in_2days || 0;
            });

            const labels = Object.keys(monthlyData);
            const totalData = labels.map(label => monthlyData[label].totalTickets);
            const resolvedData = labels.map(label => monthlyData[label].resolvedIn2Days);

            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Tickets',
                            data: totalData,
                            borderColor: 'rgb(79, 70, 229)',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgb(79, 70, 229)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5
                        },
                        {
                            label: 'Resolved in 2 Days',
                            data: resolvedData,
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgb(16, 185, 129)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: {
                                font: { size: 12, weight: 600 },
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        }
                    }
                }
            });
        }

        // Update success rate chart
        function updateSuccessRateChart(primary, compare) {
            const ctx = document.getElementById('successRateChart').getContext('2d');

            if (successRateChartInstance) {
                successRateChartInstance.destroy();
            }

            const labels = compare ? ['Primary Period', 'Comparison Period'] : ['Primary Period'];
            const data = compare ? [primary.successRate, compare.successRate] : [primary.successRate];

            successRateChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Success Rate (%)',
                        data: data,
                        backgroundColor: [
                            'rgba(79, 70, 229, 0.8)',
                            'rgba(16, 185, 129, 0.8)'
                        ],
                        borderColor: [
                            'rgb(79, 70, 229)',
                            'rgb(16, 185, 129)'
                        ],
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: {
                                font: { size: 12, weight: 600 },
                                padding: 15
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            ticks: {
                                callback: function (value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update stats table
        function updateStatsTable(records) {
            const tableBody = document.getElementById('statsTableBody');

            if (!records || records.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: var(--spacing-lg); color: var(--gray-500);">
                            No data available for the selected period
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            records.forEach(record => {
                const successRate = record.success_rate || 0;
                html += `
                    <tr>
                        <td class="project-name-cell">
                            <div class="project-name-content">
                                <i class="fas fa-calendar-alt"></i>
                                <span>${record.displayName || `${record.year}-${record.month}`}</span>
                            </div>
                        </td>
                        <td class="stats-value-cell">${record.total_tickets || 0}</td>
                        <td class="stats-value-cell">
                            <span class="badge badge-success">${record.resolved_in_2days || 0}</span>
                        </td>
                        <td class="stats-value-cell">
                            <span class="badge badge-info">${record.resolved_after_2days || 0}</span>
                        </td>
                        <td class="stats-value-cell">
                            <span class="percentage">${successRate.toFixed(2)}%</span>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
        }

        // Export report as CSV
        function exportReport() {
            if (!selectedProject) {
                alert('Please select a project and load statistics first');
                return;
            }

            const primaryYear = document.getElementById('primaryYear').value || 'All';
            const primaryQuarter = document.getElementById('primaryQuarter').value || 'All';
            const primaryMonth = document.getElementById('primaryMonth').value || 'All';

            const enableComparison = document.getElementById('enableComparison').checked;

            // Get current data from page
            const totalTickets = document.getElementById('totalTickets').textContent;
            const resolvedIn2Days = document.getElementById('resolvedIn2Days').textContent;
            const resolvedAfter2Days = document.getElementById('resolvedAfter2Days').textContent;
            const successRate = document.getElementById('successRate').textContent;

            // Create CSV content
            let csvContent = 'data:text/csv;charset=utf-8,';
            csvContent += 'QA Analytics Statistics Report\n';
            csvContent += `Generated: ${new Date().toLocaleString()}\n\n`;
            csvContent += `Project,${selectedProject.name}\n`;
            csvContent += `Primary Period,Year: ${primaryYear} | Quarter: ${primaryQuarter} | Month: ${primaryMonth}\n`;

            if (enableComparison) {
                const compareYear = document.getElementById('compareYear').value || 'All';
                const compareQuarter = document.getElementById('compareQuarter').value || 'All';
                const compareMonth = document.getElementById('compareMonth').value || 'All';
                csvContent += `Comparison Period,Year: ${compareYear} | Quarter: ${compareQuarter} | Month: ${compareMonth}\n`;
            }

            csvContent += '\nSUMMARY STATISTICS\n';
            csvContent += `Total Tickets,${totalTickets}\n`;
            csvContent += `Resolved in 2 Days,${resolvedIn2Days}\n`;
            csvContent += `Resolved After 2 Days,${resolvedAfter2Days}\n`;
            csvContent += `Success Rate,${successRate}\n\n`;
            csvContent += 'DETAILED STATISTICS\n';
            csvContent += 'Month,Total Tickets,Resolved in 2 Days,Resolved After 2 Days,Success Rate\n';

            // Add table data
            const table = document.querySelector('.stats-table tbody');
            table.querySelectorAll('tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 1) {
                    const month = cells[0].innerText;
                    const total = cells[1].innerText;
                    const resolved = cells[2].innerText;
                    const after = cells[3].innerText;
                    const rate = cells[4].innerText;
                    csvContent += `${month},${total},${resolved},${after},${rate}\n`;
                }
            });

            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `statistics_${selectedProject.name}_${new Date().getTime()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Show confirmation
            alert('Report exported successfully!');
        }

        // Set current year in footer
        document.getElementById('year').textContent = new Date().getFullYear();

        // Load projects on page load
        window.addEventListener('load', () => {
            loadProjects();
        });

        // Prevent closing modal by clicking outside when no project is selected
        window.onclick = function (event) {
            const modal = document.getElementById('projectModal');
            if (event.target === modal && selectedProject) {
                closeProjectModal();
            }
        }
    </script>
    <script src="/src/static/toast.js"></script>

    <style>
        /* New Centered Navigation Styles */
        .navbar-container-new {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-lg) var(--spacing-xl);
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: var(--spacing-xl);
        }

        .navbar-links-left {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
            justify-content: flex-start;
        }

        .navbar-links-right {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
            justify-content: flex-end;
        }

        .navbar-brand-center {
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            padding: var(--spacing-sm);
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-radius: var(--radius-2xl);
            border: 2px solid rgba(79, 70, 229, 0.2);
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
        }

        .navbar-brand-center:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 24px rgba(79, 70, 229, 0.35);
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
        }

        .navbar-brand-center .navbar-brand-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.75rem;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
            transition: all 0.3s ease;
        }

        .navbar-brand-center:hover .navbar-brand-icon {
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.5);
        }

        .navbar-links-left .nav-btn,
        .navbar-links-right .nav-btn {
            padding: 0.875rem 1.5rem;
            background: rgba(255, 255, 255, 0.7);
            color: var(--gray-700);
            border: 2px solid transparent;
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: 0.9375rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            white-space: nowrap;
        }

        .navbar-links-left .nav-btn:hover,
        .navbar-links-right .nav-btn:hover {
            background: white;
            color: var(--primary);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }

        .navbar-links-left .nav-btn.active,
        .navbar-links-right .nav-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .navbar-links-left .nav-btn i,
        .navbar-links-right .nav-btn i {
            font-size: 1rem;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .navbar-container-new {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
            }

            .navbar-brand-center {
                order: -1;
                justify-content: center;
                width: 100%;
            }

            .navbar-links-left,
            .navbar-links-right {
                justify-content: center;
                flex-wrap: wrap;
            }
        }

        @media (max-width: 768px) {

            .navbar-links-left .nav-btn span:not(.fas),
            .navbar-links-right .nav-btn span:not(.fas) {
                display: none;
            }

            .navbar-links-left .nav-btn,
            .navbar-links-right .nav-btn {
                padding: 0.75rem;
                min-width: 44px;
                justify-content: center;
            }

            .navbar-brand-center .navbar-brand-icon {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
        }
    </style>

    <script>
        // Dropdown functionality
        document.addEventListener('DOMContentLoaded', function () {
            const dropdowns = document.querySelectorAll('.nav-dropdown');

            dropdowns.forEach(dropdown => {
                const toggle = dropdown.querySelector('.dropdown-toggle');

                toggle.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Close other dropdowns
                    dropdowns.forEach(d => {
                        if (d !== dropdown) {
                            d.classList.remove('active');
                        }
                    });

                    // Toggle current dropdown
                    dropdown.classList.toggle('active');
                });
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function () {
                dropdowns.forEach(dropdown => {
                    dropdown.classList.remove('active');
                });
            });

            // Prevent dropdown from closing when clicking inside it
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.addEventListener('click', function (e) {
                    e.stopPropagation();
                });
            });
        });
    </script>
</body>

</html>